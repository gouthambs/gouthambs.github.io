<!DOCTYPE html>
<html>
    <head>
        <title>Python Multiprocessing as a Task Queue - Karuth</title>
        <meta charset="utf-8" />
        <!--link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'-->
        <link href="http://bootswatch.com/journal/bootstrap.min.css" rel="stylesheet"/>
        <link href="http://karuth.com/theme/static/css/style.css" rel="stylesheet" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    </head>

    <body id="index" class="archive">
        <div class="container">
            <div class="header">
                <ul class="nav nav-pills pull-right">
                    <li class=""><a href="http://karuth.com">Home</a></li>
                    <li><a href="http://karuth.com/pages/about.html">About</a></li>
                    <li><a href="http://karuth.com/archives.html">Archives</a></li>
                </ul>
                <h3 class="text-muted"><a href="http://karuth.com">Karuth</a></h3>
             </div>

<section id="content" class="article content">
  <header>
    <h1 class="entry-title">
      <a href="http://karuth.com/python-multiprocessing-as-a-task-queue.html" rel="bookmark"
         title="Permalink to Python Multiprocessing as a Task Queue">Python Multiprocessing as a Task Queue</a></h2>
 
  </header>
  
     
  <div class="entry-content">
    <p>When you have computationally intensive tasks in your website (or scripts),
it is conventional to use a task queue such as <a class="reference external" href="http://www.celeryproject.org/">Celery</a>. Using Celery requires
some amount of setup and if you want to avoid, try using the following task
queue based on the multiprocessing.
Depending on the application at hand, Celery might be an overkill. An alternate approach
is to use multiprocessing as a task queue.</p>
<p>Here is a simple introduction to multiprocessing:</p>
<pre class="code python literal-block">
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="k">def</span> <span class="nf">expensive_function</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="c"># do your expensive time consuming process</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
        <span class="c"># start 4 worker processes</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="c"># evaluate &quot;f(10)&quot; asynchronously</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">expensive_function</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">])</span>
        <span class="k">print</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre>
<p>The above snippet is copied from the multiprocessing documentation, and is fairly self
explanatory. In the main block we start a pool of 4 processes. Then we asynchronously
evaluate the <tt class="docutils literal">expensive_function</tt>.</p>
<p>One can use the same idea for a website as shown below in the Flask app example:</p>
<pre class="code python literal-block">
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">_pool</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">expensive_function</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="c"># import packages that is used in this function</span>
        <span class="c"># do your expensive time consuming process</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span>

<span class="nd">&#64;app.route</span><span class="p">(</span><span class="s">'/expensive_calc/&lt;int:x&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">route_expcalc</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">_pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">expensive_function</span><span class="p">,[</span><span class="n">x</span><span class="p">])</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">'Result is </span><span class="si">%d</span><span class="s">'</span><span class="o">%</span><span class="n">r</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">'__main__'</span><span class="p">:</span>
        <span class="n">_pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
                <span class="c"># insert production server deployment code</span>
                <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="n">_pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">_pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre>

  </div><!-- /.entry-content -->
   <footer class="post-info text-muted">
    Posted on <abbr class="published" title="2014-01-07T00:00:00">
      January 07, 2014
    </abbr>
    <address class="vcard author">
      by <a class="url fn" href="http://karuth.com/author/gouthaman-balaraman.html">Gouthaman Balaraman</a>
    </address> in <a href="http://karuth.com/category/articles.html">articles</a> Tagged <a href="http://karuth.com/tag/python.html">python </a><a href="http://karuth.com/tag/programming.html">programming </a>  </footer><!-- /.post-info -->
</section>
    <div class="comment">
        <div id="disqus_thread"></div> <!-- comment app container -->
    </div>
	<!-- Comment BEGIN -->
    <script type="text/javascript">
        var disqus_shortname = 'karuth'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
     <!-- Comment END -->
            <footer id="contentinfo" class="footer">
                    <nav class="pull-right bottom-nav">
                        <a href="http://karuth.com/None">RSS</a>
                    </nav>
                    <address id="about" class="vcard body">
                    &copy; <a href="http://karuth.com">Karuth</a> Proudly powered by <a href="http://getpelican.com/">Pelican</a>
                    </address><!-- /#about -->
            </footer><!-- /#contentinfo -->
        </div><!-- container -->
    </body>
</html>